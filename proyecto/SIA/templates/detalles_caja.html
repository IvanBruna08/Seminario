<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles de la Caja</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        /* CSS básico para ajustar el tamaño al de la pantalla */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: row;
            min-height: 400px;
            min-width: 400px;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.9); 
            box-shadow: 0 2px 10px rgba(109, 76, 65, 0.9); 
            border-radius: 10px; 
        }

        /* Columna de información, se adapta al espacio disponible */
        .info {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            max-height: 100%;
        }

        /* Estilo adaptable para el mapa */
        #map {
            flex: 1;
            min-height: 400px;
            min-width: 400px;
            height: 100%;
            max-width: 50%;
        }
    </style>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js'></script>
</head>
<body>
  <div class="container">
    <!-- Información -->
    <div class="info">
        <h1>Detalles del Producto</h1>
        <p><strong>Producto:</strong> {{ pallet_block.producto_blockchain }}</p>
        <p><strong>Clasificación:</strong> {{ pallet.clasificacion }}</p>
        <p><strong>Fecha de Cosecha:</strong> {{ pallet.fecha_cosecha }}</p>
        <p><strong>Tipo de Empaque:</strong> {{ caja_nor.tipo_caja.Material}}</p>
        <p><strong>Reciclable:</strong> {% if caja_nor.tipo_caja.recicable %}Sí{% else %}No{% endif %}</p>
        <h1>Información de Origen</h1>
        <p><strong>Predio:</strong> {{ predio.nombre }}</p>
        <p><strong>Ubicación:</strong> {{ predio.direccion }}</p>
        
        <h2>Ruta a Centro de Distribución</h2>
        <ul>
            <li><strong>Desde:</strong> {{ predio.nombre }}</li>
            <li><strong>Enviado al Centro de Distribución por:</strong> {{ transporte_pallet.nombre}}</li>
            <li><strong>Fecha y hora del envío:</strong> {{ recepcion.envio_pallet.fecha_inicio }}</li>
            <li><strong>Vehículo:</strong> {{ vehiculo_pallet.marca }}-{{vehiculo_pallet.patente}}</li> 
            <li><strong>Centro de Distribución:</strong> {{ distribuidor.nombre }}</li>
        </ul>

        {% if envio_caja %}
        <h2>Ruta Entrega</h2>
        <ul>
            <li><strong>Enviado por:</strong> {{ transporte_caja.nombre }}</li>
            <li><strong>Vehículo:</strong> {{ vehiculo_caja.marca }}-{{vehiculo_caja.patente}}</li>
            <li><strong>Fecha de Envío:</strong> {{ enviocajanor.fecha_inicio}}</li>
        </ul>
        {% endif %}
        
        <p><strong>Recibido el día:</strong> {{ recepcion_cliente.fecha }}</p>
    </div>

    <!-- Mapa -->
    <div id="map"></div>
  </div>

  <!-- Script del Mapa -->
  <script>
      mapboxgl.accessToken = 'pk.eyJ1IjoiaXZhYjk4IiwiYSI6ImNtMHlwdGR4bTBxemYyc3EzeWlweTB4b3UifQ.SqDs4IzkxrtKlWqrbDfNXw';
      
// Coordenadas iniciales y datos
const predioLat = parseFloat("{{ predio.latitude }}".replace(',', '.'));
      const predioLng = parseFloat("{{ predio.longitude }}".replace(',', '.'));
      const recepcionDistribuidorLat = parseFloat("{{ distribuidor.latitude }}".replace(',', '.'));
      const recepcionDistribuidorLng = parseFloat("{{ distribuidor.longitude }}".replace(',', '.'));
      const recepcionClienteLat = parseFloat("{{ recepcion_cliente.latitude }}".replace(',', '.'));
      const recepcionClienteLng = parseFloat("{{ recepcion_cliente.longitude }}".replace(',', '.'));

      const map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v12',
          center: [predioLng, predioLat],
          zoom: 12,
          minZoom: 3,
          maxZoom: 18
      });

      map.addControl(new mapboxgl.NavigationControl(), 'top-right');

      // Marcadores de los puntos
      const coordinates = [
          [predioLng, predioLat],
          [recepcionDistribuidorLng, recepcionDistribuidorLat],
          [recepcionClienteLng, recepcionClienteLat]
      ];

      // Etiquetas de los puntos
      const pointLabels = ['Predio', 'Distribuidor', 'Cliente'];
      coordinates.forEach((coord, index) => {
          new mapboxgl.Marker()
              .setLngLat(coord)
              .setPopup(new mapboxgl.Popup().setHTML(`<strong>${pointLabels[index]}</strong>`))
              .addTo(map);
      });

      // Solicitar la ruta usando la Directions API
      const routeUrl = `https://api.mapbox.com/directions/v5/mapbox/driving/${predioLng},${predioLat};${recepcionDistribuidorLng},${recepcionDistribuidorLat};${recepcionClienteLng},${recepcionClienteLat}?geometries=geojson&access_token=${mapboxgl.accessToken}`;

      fetch(routeUrl)
          .then(response => response.json())
          .then(data => {
              const route = data.routes[0].geometry;
              
              map.addSource('route', {
                  'type': 'geojson',
                  'data': {
                      'type': 'Feature',
                      'properties': {},
                      'geometry': route
                  }
              });

              map.addLayer({
                  'id': 'route',
                  'type': 'line',
                  'source': 'route',
                  'layout': {
                      'line-join': 'round',
                      'line-cap': 'round'
                  },
                  'paint': {
                      'line-color': '#888',
                      'line-width': 6
                  }
              });

              const bounds = coordinates.reduce((bounds, coord) => {
                  return bounds.extend(coord);
              }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));

              map.fitBounds(bounds, { padding: 50 });
          })
          .catch(error => console.error('Error al cargar la ruta:', error));
  </script>
</body>
</html>
